<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Razka Bintang Firdaus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <style>
        /* Definisi Warna Neon */
        .bg-dark { background-color: #111827; }
        .bg-card-dark { background-color: #1f2937; }
        .text-primary-pink { color: #F7668F; }
        .border-primary-pink { border-color: #F7668F; }
        .shadow-pink-glow { box-shadow: 0 0 15px rgba(247, 102, 143, 0.4); }
        .text-secondary-lilac { color: #C084FC; }
        .border-secondary-lilac { border-color: #C084FC; }
        .shadow-lilac-glow { box-shadow: 0 0 15px rgba(192, 132, 252, 0.4); }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Background Super Gelap */
            color: #e5e7eb;
            line-height: 1.6;
        }

        /* Styling untuk scrollbar custom (horizontal di mobile) */
        .vibe-scroll::-webkit-scrollbar {
            height: 3px;
        }
        .vibe-scroll::-webkit-scrollbar-thumb {
            background-color: #F7668F;
            border-radius: 2px;
        }
    </style>
</head>
<body id="app-body">

    <div id="app-container" class="p-4 w-full max-w-md mx-auto pb-16 min-h-screen">
        <div class="flex justify-center items-center min-h-screen">
            <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-t-4 border-primary-pink"></div>
            <p class="ml-4 text-secondary-lilac text-lg">Loading Vibe...</p>
        </div>
    </div>

    <div id="edit-modal-container" class="hidden"></div>
    <div id="image-modal-container" class="hidden"></div>

    <script type="module">
        // Import modul Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variabel Global dari Lingkungan Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'github-link-in-bio';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- KONSTANTA & DEFAULT DATA ---
        const defaultProfile = {
            name: 'Razka Bintang Firdaus',
            // FIX: Menggunakan petik ganda untuk menghindari error sintaks pada petik tunggal '
            // FIX: Menambahkan koma (,) setelah bio
            bio: "AI Addict | 05' | ENFP", 
            profilePicUrl: 'https://photos.app.goo.gl/fGhDbXoebjaf9drL7', // Foto utama
            spotifyUrl: 'https://open.spotify.com/track/54mnwt3kO0uYsy0ceg14JP?si=WlJNWu66RE2H9dIctnOnfw',
            vibes: {
                kpop: 'TWICE, aespa, Hearts2Hearts, LE SSERAFIM',
                motogp: 'Marc Marquez MM93 - #MoreThanANumber',
                football: 'Real Madrid üëë'
            },
        };

        // Definisi Kumpulan Foto untuk Setiap Vibe
        // NOTE: Ganti URL placeholder ini dengan link foto asli kamu.
        const kpopImages = [
            { src: 'https://photos.app.goo.gl/71Uh9xMmLd6GACup6', alt: 'TWICE' }, 
            { src: 'https://photos.app.goo.gl/kXTk98o9obbFW1XD9', alt: 'AESPA' }, 
            { src: 'https://photos.app.goo.gl/3UUAEhevuq62U8dAA', alt: 'LE SSERAFIM' }, 
            { src: 'https://photos.app.goo.gl/kpfHcUv5QbjStumL9', alt: 'Hearts2Hearts' }
        ];
        const motogpImages = [
            { src: 'https://photos.app.goo.gl/nBjCowNBmtS9CZtY6', alt: 'Marc Marquez' }
        ];
        const footballImages = [
            { src: 'https://photos.app.goo.gl/kr4Wp27s74121JUP6', alt: 'Real Madrid' }
        ];


        // --- FIREBASE INSTANCES ---
        let app, db, auth;
        let userId = null;

        // --- PATH FIREBASE ---
        const PUBLIC_PATH = `artifacts/${appId}/public/data/profile_public/user_data`;
        const getPrivatePath = (uid) => `artifacts/${appId}/users/${uid}/profile/user_data`;

        // --- UTILITY FUNCTIONS ---
        const getSpotifyTrackId = (url) => {
            try {
                if (!url) return '';
                const urlObj = new URL(url);
                const pathSegments = urlObj.pathname.split('/');
                const trackIndex = pathSegments.indexOf('track');
                if (trackIndex !== -1 && pathSegments.length > trackIndex + 1) {
                    return pathSegments[trackIndex + 1].split('?')[0]; 
                }
                return '';
            } catch (error) {
                return '';
            }
        };

        const getSpotifyEmbedUrl = (trackUrl) => {
            const trackId = getSpotifyTrackId(trackUrl);
            // FIX: Mengubah URL embed Spotify menjadi yang benar (Spotify Embed URL)
            return trackId ? `https://open.spotify.com/embed/track/${trackId}?utm_source=generator&theme=0` : '';
        };

        // --- INITIALIZATION ---
        const initializeAppAndAuth = async () => {
            if (!firebaseConfig) {
                console.warn("Firebase config tidak ditemukan. Menggunakan data default.");
                // Jika config tidak ada, langsung render dengan data default
                renderApp(defaultProfile);
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                    userId = userCredential.user.uid;
                } else {
                    const userCredential = await signInAnonymously(auth);
                    userId = userCredential.user.uid;
                }
                console.log("Firebase Auth Success. User ID:", userId);
                
                listenToPublicProfile();

            } catch (e) {
                console.error("Firebase Initialization or Auth Error:", e);
                userId = auth?.currentUser?.uid || crypto.randomUUID();
                // FIX: Menghapus error box karena ini mengganggu UI
                // Jika ada error Firebase, kita tetap coba listen/render dengan data default
                
                listenToPublicProfile();
            }
        };
        
        // --- FIREBASE LISTEN (READ) ---
        const listenToPublicProfile = () => {
            if (!db) {
                // Jika DB gagal inisialisasi, pastikan kita merender minimal dengan data default
                renderApp(defaultProfile, "Database tidak siap. Menampilkan data default.");
                return;
            }

            const profileDocRef = doc(db, PUBLIC_PATH);
            
            onSnapshot(profileDocRef, (docSnap) => {
                let profileData = defaultProfile;
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    profileData = {
                        ...defaultProfile, 
                        ...data,
                        vibes: { ...defaultProfile.vibes, ...data.vibes }
                    };
                }
                renderApp(profileData);
            }, (e) => {
                console.error("Firestore Listen Error:", e);
                renderApp(defaultProfile, "Gagal memuat data live. Menampilkan data default.");
            });
        }

        // --- FIREBASE WRITE (SAVE) ---
        window.saveProfile = async (newProfile) => {
            if (!db || !userId) {
                console.error("Database atau User ID tidak siap.");
                return;
            }

            const privateDocRef = doc(db, getPrivatePath(userId));
            const publicDocRef = doc(db, PUBLIC_PATH);

            try {
                await Promise.all([
                    setDoc(privateDocRef, newProfile, { merge: true }),
                    setDoc(publicDocRef, newProfile, { merge: true })
                ]);
                console.log("Profile saved successfully to both private and public paths.");
            } catch (e) {
                console.error("Error saving profile:", e);
            }
        };

        // --- UI RENDER FUNCTIONS ---
        const renderVibeItem = (emoji, title, content, color, onClickFn) => `
            <div 
                onclick="${onClickFn}"
                class="p-4 rounded-xl mb-3 border-l-4 border-${color} bg-gray-800/50 shadow-lg cursor-pointer transition transform hover:scale-[1.01] hover:bg-gray-700/50"
            >
                <div class="text-lg font-bold flex items-center text-${color}">
                    <span class="text-2xl mr-3">${emoji}</span>
                    ${title}
                </div>
                <p class="text-sm text-gray-300 mt-1 pl-8 overflow-hidden whitespace-nowrap overflow-x-auto vibe-scroll">${content}</p>
            </div>
        `;

        const renderPrimaryButton = (text, onClickFn, colorClass, hoverClass, shadowClass) => `
            <button
                onclick="${onClickFn}"
                class="w-full flex items-center justify-center p-4 rounded-xl text-center font-bold text-lg transition duration-300 transform hover:scale-[1.02] 
                        bg-card-dark border-2 ${colorClass} ${hoverClass} ${shadowClass} hover:shadow-2xl text-gray-100 hover:text-bg-dark"
            >
                <span class="truncate">${text}</span>
            </button>
        `;

        const renderApp = (profile) => {
            const container = document.getElementById('app-container');
            const spotifyEmbedUrl = getSpotifyEmbedUrl(profile.spotifyUrl);
            
            // FIX: Menggunakan fungsi untuk memastikan JSON string di dalam atribut onclick
            const jsonEscape = (data) => JSON.stringify(data).replace(/"/g, '&quot;');

            // Handler untuk Modal Gambar
            const profileClick = `showImageModal('Foto Profil Utama', '${profile.profilePicUrl}')`;
            // FIX: Menggunakan jsonEscape untuk array objek
            const kpopClick = `showImageModal('K-Pop Squad', '${jsonEscape(kpopImages)}')`;
            const motogpClick = `showImageModal('Rider Favorit', '${jsonEscape(motogpImages)}')`;
            const footballClick = `showImageModal('Team Bola', '${jsonEscape(footballImages)}')`;


            const editButton = userId ? `
                <button 
                    onclick="showEditModal('${jsonEscape(profile)}')"
                    class="absolute top-0 right-0 p-2 bg-card-dark text-primary-pink rounded-full border border-primary-pink/50 hover:bg-primary-pink hover:text-bg-dark transition shadow-lg"
                    title="Edit Profil"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                    </svg>
                </button>
            ` : '';

            const spotifySection = spotifyEmbedUrl ? `
                <section class="mb-8 bg-card-dark p-5 rounded-2xl shadow-2xl border-2 border-secondary-lilac/50 shadow-lilac-glow/30">
                    <h2 class="text-2xl font-bold mb-4 flex items-center justify-center text-secondary-lilac">
                        <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.578 17.56c-.244.398-.753.535-1.15.293-2.617-1.61-5.962-2.02-9.923-1.17-.456.095-.91-.186-1.005-.642-.095-.456.186-.91.642-1.005 4.363-.91 8.163-.44 11.23 1.488.398.244.535.753.293 1.15zM12 21.05c-5.006 0-9.05-4.044-9.05-9.05s4.044-9.05 9.05-9.05 9.05 4.044 9.05 9.05-4.044 9.05-9.05 9.05zm-.15-1.5c.08-.184.148-.37.214-.56-.066-.19-.134-.376-.214-.56zm3.33-3.66c-.198.32-.61.428-.93.23-2.18-1.34-4.966-1.69-8.31-1.045-.37.076-.73-.13-.806-.5s.13-.73.5-.806c3.67-.754 6.78-1.74 9.387 1.07.28.165.37.545.163.855z"/></svg>
                        CURRENTLY LISTENING
                    </h2>
                    <div class="rounded-xl overflow-hidden shadow-2xl">
                        <iframe 
                            src="${spotifyEmbedUrl}" 
                            width="100%" 
                            height="152" 
                            frameborder="0" 
                            allowfullscreen="" 
                            allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                            loading="lazy"
                            title="Spotify Embed Player"
                        ></iframe>
                    </div>
                </section>
            ` : `<div class="mb-8 p-5 text-center text-gray-500 italic">
                    Masukkan URL Spotify track penuh di menu edit untuk menampilkan lagu di sini.
                </div>`;


            container.innerHTML = `
                <p class="text-xs text-center text-gray-500 mb-2 mt-4">
                    User ID (Hanya untuk editing): <span class="text-secondary-lilac font-mono break-all">${userId || 'N/A'}</span>
                </p>

                <div class="text-center my-6 relative">
                    ${editButton}

                    <img 
                        src="${profile.profilePicUrl}" 
                        alt="Profil ${profile.name}" 
                        onclick="${profileClick}"
                        class="w-32 h-32 rounded-full mx-auto mb-3 border-4 border-secondary-lilac shadow-xl object-cover cursor-pointer transition transform hover:scale-105 hover:shadow-lilac-glow"
                        onerror="this.onerror=null;this.src='${defaultProfile.profilePicUrl}';"
                    />

                    <h1 class="text-4xl font-extrabold text-primary-pink tracking-tight">
                        ${profile.name}
                    </h1>
                    <p class="text-md text-gray-400 mt-1 italic break-words">${profile.bio}</p>
                </div>
                
                <div class="h-0.5 bg-gradient-to-r from-primary-pink to-secondary-lilac rounded-full my-8"></div>

                ${spotifySection}

                <section class="mb-8 bg-card-dark p-5 rounded-2xl shadow-2xl border-2 border-primary-pink/50 shadow-pink-glow/30">
                    <h2 class="text-2xl font-extrabold mb-4 text-primary-pink text-center tracking-wider">
                        ‚ú® V I B E S   C H E C K ‚ú®
                    </h2>
                    
                    ${renderVibeItem("ü©∑", "K-Pop Squad", profile.vibes.kpop, "primary-pink", kpopClick)}
                    ${renderVibeItem("üèçÔ∏è", "Rider Favorit", profile.vibes.motogp, "secondary-lilac", motogpClick)}
                    ${renderVibeItem("‚öΩ", "Team Bola", profile.vibes.football, "primary-pink", footballClick)}
                    
                    <p class="text-xs text-center text-gray-500 mt-4 italic">
                        *Tap pada VIBES atau foto profil untuk lihat foto terkait!
                    </p>
                </section>
                
                <div class="h-0.5 bg-gradient-to-r from-secondary-lilac to-primary-pink rounded-full my-8"></div>

                <section class="space-y-4 mb-8">
                    
                    ${renderPrimaryButton("IG Utama (@razkabf)", "window.open('https://www.instagram.com/razkabf', '_blank')", "border-primary-pink text-primary-pink", "hover:bg-primary-pink", "shadow-pink-glow/50")}
                    
                    ${renderPrimaryButton("IG Kedua (@byrazka.jpg)", "window.open('https://www.instagram.com/byrazka.jpg', '_blank')", "border-secondary-lilac text-secondary-lilac", "hover:bg-secondary-lilac", "shadow-lilac-glow/50")}

                    ${renderPrimaryButton("TikTok (@hiraiyizhuo)", "window.open('https://www.tiktok.com/@hiraiyizhuo', '_blank')", "border-primary-pink text-primary-pink", "hover:bg-primary-pink", "shadow-pink-glow/50")}

                    ${renderPrimaryButton("Email (razkabintangfirdaus@gmail.com)", "window.open('mailto:razkabintangfirdaus@gmail.com', '_blank')", "border-secondary-lilac text-secondary-lilac", "hover:bg-secondary-lilac", "shadow-lilac-glow/50")}
                </section>
            `;
        };
        
        // --- DYNAMIC IMAGE MODAL (Fixed JSON Parsing) ---

        window.showImageModal = (title, imagesData) => {
            const container = document.getElementById('image-modal-container');
            container.classList.remove('hidden');

            let images = [];
            // FIX: Menggunakan &quot; untuk parsing data dari HTML attribute
            if (imagesData.includes('&quot;')) {
                try {
                    const cleanJson = imagesData.replace(/&quot;/g, '"'); 
                    images = JSON.parse(cleanJson);
                } catch (e) {
                    console.error("Error parsing imagesData:", e);
                    images = [];
                }
            } else if (typeof imagesData === 'string' && imagesData.startsWith('http')) {
                // Input adalah string URL tunggal (untuk foto profil)
                images.push({ src: imagesData, alt: title });
            }

            const isSingleImage = images.length === 1;
            // Tentukan grid class
            let gridClass = 'grid-cols-2 sm:grid-cols-3';
            if (isSingleImage) {
                gridClass = 'grid-cols-1';
            } else if (images.length === 4) {
                gridClass = 'grid-cols-2';
            }

            const imagesHtml = images.map((img, index) => `
                <img 
                    src="${img.src}" 
                    alt="${img.alt || 'Gambar ' + (index + 1)}" 
                    class="w-full h-auto rounded-xl object-cover border-2 border-primary-pink/50 shadow-lg transform transition duration-300 hover:scale-105 hover:shadow-pink-glow mx-auto"
                    style="aspect-ratio: 3/4; max-width: ${isSingleImage ? '300px' : '100%'};"
                    onerror="this.onerror=null;this.src='https://placehold.co/180x250/334155/e2e8f0?text=FOTO';"
                />
            `).join('');

            container.innerHTML = `
                <div 
                    class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4 backdrop-blur-sm transition duration-300"
                    onclick="hideImageModal()" 
                >
                    <div 
                        class="bg-card-dark rounded-2xl w-full max-w-lg p-6 shadow-2xl border-2 border-secondary-lilac/80 max-h-[90vh] flex flex-col transform transition duration-300 scale-100"
                        onclick="event.stopPropagation()" 
                    >
                        <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-3">
                            <h2 class="text-xl sm:text-2xl font-bold text-primary-pink">${title} üì∏</h2>
                            <button 
                                onclick="hideImageModal()" 
                                class="text-gray-400 hover:text-white transition p-2 rounded-full bg-gray-700 hover:bg-primary-pink"
                                aria-label="Tutup Galeri"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                        
                        <div class="grid ${gridClass} gap-3 overflow-y-auto pr-1 -mr-1 justify-center">
                            ${imagesHtml}
                        </div>
                        ${!isSingleImage ? `<p class="text-center text-xs text-gray-500 mt-4 italic">
                            Galeri Vibe: ${images.length} Foto
                        </p>` : ''}
                    </div>
                </div>
            `;
        };

        window.hideImageModal = () => {
            document.getElementById('image-modal-container').classList.add('hidden');
        };
        
        // --- MODAL EDIT LOGIC ---

        window.showEditModal = (profileJsonString) => {
            if (!userId) return; 

            // FIX: Parsing JSON string yang sudah di-escape dari atribut HTML
            let currentProfile;
            try {
                currentProfile = JSON.parse(profileJsonString.replace(/&quot;/g, '"'));
            } catch(e) {
                console.error("Error parsing currentProfile:", e);
                currentProfile = defaultProfile; // Gunakan default jika gagal parse
            }
            
            const container = document.getElementById('edit-modal-container');
            container.classList.remove('hidden');

            let formData = {
                name: currentProfile.name,
                bio: currentProfile.bio,
                profilePicUrl: currentProfile.profilePicUrl, 
                spotifyUrl: currentProfile.spotifyUrl,
                kpopVibe: currentProfile.vibes.kpop,
                motogpVibe: currentProfile.vibes.motogp,
                footballVibe: currentProfile.vibes.football,
            };
            
            // Re-define handlers to prevent stale data
            window.handleInputChange = (e) => {
                const { name, value } = e.target;
                formData[name] = value;
            };

            window.handleSaveClick = async () => {
                const saveButton = document.getElementById('save-button');
                saveButton.innerHTML = 'Menyimpan...';
                saveButton.disabled = true;

                const newVibes = {
                    kpop: formData.kpopVibe,
                    motogp: formData.motogpVibe,
                    football: formData.footballVibe,
                };
                const updatedProfile = {
                    name: formData.name,
                    bio: formData.bio,
                    profilePicUrl: formData
